name: Pylint

on:
  push:
    branches: ["dev", "master"]
    paths:
      - "pyzx/graph/graph_neo4j.py"
  pull_request:
    branches: ["master"]
    paths:
      - "pyzx/graph/graph_neo4j.py"

jobs:
  pylint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f test_requirements.txt ]; then pip install -r test_requirements.txt; fi
          pip install pylint

      - name: Run pylint (min score 9.5)
        shell: bash
        run: |
          set -euo pipefail

          pylint pyzx/graph/graph_neo4j.py | tee pylint.log || true

          SCORE=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1)

          if [ -z "${SCORE:-}" ]; then
            echo "Could not determine pylint score."
            cat pylint.log
            exit 1
          fi

          echo "Pylint score: $SCORE"

          python - <<PY
          import sys
          score = float("$SCORE")
          threshold = 9.5
          if score < threshold:
              print(f"FAIL: pylint score {score} < {threshold}")
              sys.exit(1)
          print(f"PASS: pylint score {score} >= {threshold}")
          PY
