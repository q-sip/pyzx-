name: Agent: neo4j docs + tests + pylint fixes

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to run the agent on (and PR back into)"
        required: true
        default: "dev"
      enable_pylint_fixes:
        description: "Try to fix pylint issues if score below threshold"
        required: true
        default: "true"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: agent-neo4j
  cancel-in-progress: false

jobs:
  agent:
    runs-on: self-hosted

    env:
      UPSTREAM_OWNER: zxcalc
      UPSTREAM_REPO: pyzx
      UPSTREAM_BRANCH: master

      AGENT_BASE_URL: ${{ secrets.AGENT_BASE_URL }}
      AGENT_MODEL: ${{ secrets.AGENT_MODEL }}
      AGENT_API_KEY: ${{ secrets.AGENT_API_KEY }}

      PR_TOKEN: ${{ secrets.SYNC_TOKEN || github.token }}
      PYLINT_THRESHOLD: "9.5"

      # Where standalone markdown docs are allowed to be created/updated
      DOCS_PATH: docs/neo4j/graph_neo4j.md

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f test_requirements.txt ]; then pip install -r test_requirements.txt; fi
          pip install mypy pylint pytest requests

      - name: LLM health check (OpenAI-compatible)
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, requests
          base = os.environ["AGENT_BASE_URL"].rstrip("/")
          if not base.endswith("/v1"):
            base += "/v1"
          r = requests.get(base + "/models", timeout=30)
          r.raise_for_status()
          print("LLM OK:", r.status_code)
          PY

      - name: Add upstream remote and fetch
        run: |
          set -euo pipefail
          git remote get-url upstream >/dev/null 2>&1 || \
            git remote add upstream "https://github.com/${UPSTREAM_OWNER}/${UPSTREAM_REPO}.git"
          git fetch upstream "${UPSTREAM_BRANCH}" --prune --tags

      - name: Compute fork-touched files (diff vs upstream/master)
        id: touched
        run: |
          set -euo pipefail
          git diff --name-only "upstream/${UPSTREAM_BRANCH}...HEAD" > touched_files_all.txt
          grep -E '^pyzx/.*\.py$' touched_files_all.txt | grep -vE '^tests/' > touched_py_files.txt || true

          echo "Touched python files:"
          cat touched_py_files.txt || true

          if [ -s touched_py_files.txt ]; then
            echo "has_touched_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_touched_py=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop if no fork-touched Python files
        if: steps.touched.outputs.has_touched_py != 'true'
        run: |
          echo "No fork-touched Python files vs upstream/${UPSTREAM_BRANCH}. Nothing to document."
          exit 0

      - name: Run agent to generate docs + tests + standalone markdown docs
        run: |
          set -euo pipefail
          python tools/agent/agent.py \
            --mode docs-tests \
            --touched-files touched_py_files.txt \
            --focus-file pyzx/graph/graph_neo4j.py \
            --tests-dir tests/test_graph_neo4j \
            --docs-path "${DOCS_PATH}"

      - name: Guardrail: restrict changed files
        run: |
          set -euo pipefail
          git diff --name-only > changed_files.txt || true

          if [ ! -s changed_files.txt ]; then
            echo "No changes produced by agent."
            exit 0
          fi

          echo "Agent changed files:"
          cat changed_files.txt

          ALLOWED_TEST_PREFIX="tests/test_graph_neo4j/"
          ALLOWED_DOC_FILE="${DOCS_PATH}"

          while read -r f; do
            [ -z "$f" ] && continue

            # Allow any python file already touched in the fork (vs upstream)
            if grep -qxF "$f" touched_py_files.txt; then
              continue
            fi

            # Allow neo4j test area
            if [[ "$f" == "$ALLOWED_TEST_PREFIX"* ]]; then
              continue
            fi

            # Allow exactly this one docs file (standalone doc)
            if [ "$f" = "$ALLOWED_DOC_FILE" ]; then
              continue
            fi

            echo "ERROR: Agent modified disallowed file: $f"
            exit 1
          done < changed_files.txt

      - name: Run mypy
        run: |
          set -euo pipefail
          mypy pyzx/ tests/

      - name: Run pylint (graph_neo4j.py)
        run: |
          set -euo pipefail
          pylint pyzx/graph/graph_neo4j.py | tee pylint.log || true

          SCORE=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)
          if [ -z "${SCORE:-}" ]; then
            echo "Could not determine pylint score."
            exit 1
          fi

          echo "Pylint score: $SCORE"
          python - <<PY
          import sys
          score = float("$SCORE")
          threshold = float("${PYLINT_THRESHOLD}")
          if score < threshold:
              sys.exit(2)
          sys.exit(0)
          PY

      - name: Agent: attempt pylint fixes (optional)
        if: inputs.enable_pylint_fixes == 'true'
        run: |
          set -euo pipefail

          # Only run fixes if current score is below threshold
          SCORE=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)
          python - <<PY
          import sys
          score = float("${SCORE:-0}")
          threshold = float("${PYLINT_THRESHOLD}")
          sys.exit(0 if score < threshold else 1)
          PY
          NEED_FIX=$?

          if [ "$NEED_FIX" -ne 0 ]; then
            echo "Pylint already >= threshold; skipping fixes."
            exit 0
          fi

          python tools/agent/agent.py \
            --mode pylint-fix \
            --pylint-log pylint.log \
            --focus-file pyzx/graph/graph_neo4j.py

          pylint pyzx/graph/graph_neo4j.py | tee pylint_after.log || true
          SCORE2=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint_after.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)
          if [ -z "${SCORE2:-}" ]; then
            echo "Could not determine pylint score after fixes."
            exit 1
          fi

          echo "Pylint score after fixes: $SCORE2"
          python - <<PY
          import sys
          score = float("$SCORE2")
          threshold = float("${PYLINT_THRESHOLD}")
          if score < threshold:
              sys.exit(1)
          sys.exit(0)
          PY

      - name: Run end-to-end tests (pytest)
        run: |
          set -euo pipefail
          pytest -q

      - name: Create PR (only after all checks succeed)
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ env.PR_TOKEN }}
          base: ${{ inputs.target_branch }}
          branch: agent/neo4j-docs-tests
          title: "Agent: neo4j docs/tests/lint improvements"
          body: |
            Automated agent PR.

            Scope:
            - Docstrings/comments for fork-touched Python files (diff vs upstream/master)
            - Standalone docs: `${{ env.DOCS_PATH }}` (with usage examples)
            - Additional tests under `tests/test_graph_neo4j/`
            - Optional pylint fixes for `pyzx/graph/graph_neo4j.py`

            Gates passed:
            - mypy
            - pylint (>= ${{ env.PYLINT_THRESHOLD }})
            - pytest
          labels: |
            upstream-sync
          delete-branch: false
