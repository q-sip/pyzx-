name: "Agent: propose neo4j docs + tests + lint fixes (no pushes)"

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch to run against (no pushes will be made)"
        required: true
        default: "dev"
      enable_pylint_fixes:
        description: "Try to fix pylint issues if score below threshold"
        required: true
        default: "true"

  schedule:
    - cron: "0 3 * * 1" # weekly Monday 03:00 UTC

  # Optional: helps visibility/indexing; runs in proposal-only mode anyway.
  push:
    branches: ["dev"]
    paths:
      - ".github/workflows/agent-neo4j.yml"
      - "tools/agent/**"

permissions:
  contents: read

concurrency:
  group: agent-neo4j-propose
  cancel-in-progress: false

jobs:
  propose:
    runs-on: self-hosted

    env:
      UPSTREAM_OWNER: zxcalc
      UPSTREAM_REPO: pyzx
      UPSTREAM_BRANCH: master

      AGENT_BASE_URL: ${{ secrets.AGENT_BASE_URL }}
      AGENT_MODEL: ${{ secrets.AGENT_MODEL }}
      AGENT_API_KEY: ${{ secrets.AGENT_API_KEY }}

      PYLINT_THRESHOLD: "9.5"
      DOCS_PATH: docs/neo4j/graph_neo4j.md

      # For schedule/push events, these inputs do not exist; read them from the event payload safely.
      TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'dev' }}
      ENABLE_PYLINT_FIXES: ${{ github.event.inputs.enable_pylint_fixes || 'true' }}

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Add upstream remote and fetch
        run: |
          set -euo pipefail
          git remote get-url upstream >/dev/null 2>&1 || \
            git remote add upstream "https://github.com/${UPSTREAM_OWNER}/${UPSTREAM_REPO}.git"
          git fetch upstream "${UPSTREAM_BRANCH}" --prune --tags

      - name: Compute fork-touched Python files (diff vs upstream/master)
        id: touched
        run: |
          set -euo pipefail
          git diff --name-only "upstream/${UPSTREAM_BRANCH}...HEAD" > touched_files_all.txt
          grep -E '^pyzx/.*\.py$' touched_files_all.txt | grep -vE '^tests/' > touched_py_files.txt || true

          echo "Touched python files:"
          cat touched_py_files.txt || true

          if [ -s touched_py_files.txt ]; then
            echo "has_touched_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_touched_py=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit early if nothing to do
        if: steps.touched.outputs.has_touched_py != 'true'
        run: |
          echo "No fork-touched Python files vs upstream/${UPSTREAM_BRANCH}. Nothing to do."
          exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f test_requirements.txt ]; then pip install -r test_requirements.txt; fi
          pip install mypy pylint pytest requests

      - name: LLM health check (OpenAI-compatible)
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, requests
          base = os.environ["AGENT_BASE_URL"].rstrip("/")
          if not base.endswith("/v1"):
            base += "/v1"
          r = requests.get(base + "/models", timeout=30)
          r.raise_for_status()
          print("LLM OK:", r.status_code)
          PY

      - name: Run agent (apply changes locally)
        run: |
          set -euo pipefail
          python tools/agent/agent.py \
            --mode docs-tests \
            --touched-files touched_py_files.txt \
            --focus-file pyzx/graph/graph_neo4j.py \
            --tests-dir tests/test_graph_neo4j \
            --docs-path "${DOCS_PATH}"

      - name: "Guardrail: restrict changed files"
        run: |
          set -euo pipefail
          git diff --name-only > changed_files.txt || true

          if [ ! -s changed_files.txt ]; then
            echo "No changes produced by agent."
            exit 0
          fi

          echo "Agent changed files:"
          cat changed_files.txt

          ALLOWED_TEST_PREFIX="tests/test_graph_neo4j/"
          ALLOWED_DOC_FILE="${DOCS_PATH}"

          while read -r f; do
            [ -z "$f" ] && continue

            # allow any python file already touched in the fork (vs upstream)
            if grep -qxF "$f" touched_py_files.txt; then
              continue
            fi

            # allow neo4j test area
            if [[ "$f" == "$ALLOWED_TEST_PREFIX"* ]]; then
              continue
            fi

            # allow exactly this standalone doc
            if [ "$f" = "$ALLOWED_DOC_FILE" ]; then
              continue
            fi

            echo "ERROR: Agent modified disallowed file: $f"
            exit 1
          done < changed_files.txt

      - name: Run mypy
        run: |
          set -euo pipefail
          mypy pyzx/ tests/

      - name: Run pylint (graph_neo4j.py)
        run: |
          set -euo pipefail
          pylint pyzx/graph/graph_neo4j.py | tee pylint.log || true
          SCORE=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)
          if [ -z "${SCORE:-}" ]; then
            echo "Could not determine pylint score."
            exit 1
          fi
          echo "Pylint score (before fixes): $SCORE"

      - name: "Agent: attempt pylint fixes (optional)"
        if: env.ENABLE_PYLINT_FIXES == 'true'
        run: |
          set -euo pipefail
          SCORE=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)

          python - <<PY
          import sys
          score = float("${SCORE:-0}")
          threshold = float("${PYLINT_THRESHOLD}")
          sys.exit(0 if score < threshold else 1)
          PY
          NEED_FIX=$?

          if [ "$NEED_FIX" -ne 0 ]; then
            echo "Pylint already >= threshold; skipping fixes."
            exit 0
          fi

          python tools/agent/agent.py \
            --mode pylint-fix \
            --pylint-log pylint.log \
            --focus-file pyzx/graph/graph_neo4j.py

          pylint pyzx/graph/graph_neo4j.py | tee pylint_after.log || true
          SCORE2=$(grep -oE 'rated at [0-9]+(\.[0-9]+)?/10' pylint_after.log | tail -n 1 | awk '{print $3}' | cut -d/ -f1 || true)
          if [ -z "${SCORE2:-}" ]; then
            echo "Could not determine pylint score after fixes."
            exit 1
          fi
          echo "Pylint score (after fixes): $SCORE2"

          python - <<PY
          import sys
          score = float("$SCORE2")
          threshold = float("${PYLINT_THRESHOLD}")
          sys.exit(0 if score >= threshold else 1)
          PY

      - name: Run end-to-end tests (pytest)
        run: |
          set -euo pipefail
          pytest -q

      - name: Produce proposal patch
        run: |
          set -euo pipefail
          git diff > agent-proposal.patch
          {
            echo "Changed files:"
            git diff --name-only
            echo
            echo "Apply with:"
            echo "  git apply agent-proposal.patch"
          } > agent-proposal.txt

      - name: Upload proposal artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-neo4j-proposal
          path: |
            agent-proposal.patch
            agent-proposal.txt
            pylint.log
            pylint_after.log
            changed_files.txt
          if-no-files-found: ignore

      - name: Write run summary
        run: |
          {
            echo "## Agent proposal (no pushes)"
            echo
            echo "**Target branch:** \`${TARGET_BRANCH}\`"
            echo
            echo "### Changed files"
            cat changed_files.txt || true
            echo
            echo "### How to apply"
            echo "\`git apply agent-proposal.patch\`"
            echo
            echo "Download the artifact **agent-neo4j-proposal** from this run."
          } >> "$GITHUB_STEP_SUMMARY"
